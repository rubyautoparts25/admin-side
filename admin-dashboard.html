<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Admin Dashboard - RUBY AUTO PARTS</title>
    <!-- Main stylesheet from public website -->
    <link rel="stylesheet" href="https://public-website-alpha-cyan.vercel.app/styles.css" id="mainStylesheet" onerror="this.onerror=null; this.href='';">
    <link rel="stylesheet" href="admin-styles.css">
    <link rel="stylesheet" href="mobile-fixes.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
</head>
<body>
    <!-- Admin Header -->
    <header style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px 0; position: sticky; top: 0; z-index: 1000;">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="https://public-website-alpha-cyan.vercel.app/logo.jpeg" alt="Logo" style="height: 40px; width: auto;" onerror="this.style.display='none';">
                    <h1 style="margin: 0; font-size: 1.5rem; color: var(--orange-dark);">Admin Dashboard</h1>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <a href="https://public-website-alpha-cyan.vercel.app/" target="_blank" style="padding: 10px 20px; background: var(--beige-light); color: var(--text-dark); text-decoration: none; border-radius: 8px; font-size: 0.9rem;">
                        <i class="fas fa-external-link-alt"></i> View Website
                    </a>
                    <button class="admin-logout-btn" onclick="logoutAdmin()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main style="padding: 40px 0; min-height: calc(100vh - 100px);">
        <div class="container">
            <!-- Inventory Summary -->
            <div id="inventorySummary" style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-dark);">
                        <i class="fas fa-chart-line"></i> Inventory Summary
                    </h2>
                    <button class="admin-add-part-btn" onclick="openAddPartModal()" style="margin: 0;">
                        <i class="fas fa-plus"></i> Add New Part
                    </button>
                </div>
                <div id="inventoryStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div onclick="showFilteredParts('all')" style="text-align: center; padding: 15px; background: var(--beige-light); border-radius: 8px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent;" onmouseover="this.style.borderColor='var(--orange-medium)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.borderColor='transparent'; this.style.transform='translateY(0)';">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--orange-dark);" id="totalParts">0</div>
                        <div style="color: var(--text-light); font-size: 0.9rem; margin-top: 5px;">Total Parts</div>
                    </div>
                    <div onclick="showFilteredParts('totalStock')" style="text-align: center; padding: 15px; background: var(--beige-light); border-radius: 8px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent;" onmouseover="this.style.borderColor='var(--orange-medium)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.borderColor='transparent'; this.style.transform='translateY(0)';">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--orange-dark);" id="totalStock">0</div>
                        <div style="color: var(--text-light); font-size: 0.9rem; margin-top: 5px;">Total Stock</div>
                    </div>
                    <div onclick="showFilteredParts('lowStock')" style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 193, 7, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';" id="lowStockAlert">
                        <div style="font-size: 2rem; font-weight: 700; color: #f57c00;" id="lowStockCount">0</div>
                        <div style="color: var(--text-light); font-size: 0.9rem; margin-top: 5px;">
                            <i class="fas fa-exclamation-triangle"></i> Low Stock Items
                        </div>
                    </div>
                    <div onclick="showFilteredParts('outOfStock')" style="text-align: center; padding: 15px; background: #f8d7da; border-radius: 8px; border: 2px solid #dc3545; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';" id="outOfStockAlert">
                        <div style="font-size: 2rem; font-weight: 700; color: #dc3545;" id="outOfStockCount">0</div>
                        <div style="color: var(--text-light); font-size: 0.9rem; margin-top: 5px;">
                            <i class="fas fa-times-circle"></i> Out of Stock
                        </div>
                    </div>
                </div>
            </div>

            <!-- Low Stock Alert Banner -->
            <div id="lowStockBanner" style="display: none; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem;"></i>
                        <div>
                            <h3 style="margin: 0; font-size: 1.2rem;">Low Stock Alert</h3>
                            <p style="margin: 5px 0 0 0; opacity: 0.9;" id="lowStockMessage">Some items are running low on stock</p>
                        </div>
                    </div>
                    <button onclick="scrollToLowStock()" style="background: white; color: #ff6b6b; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        View Items <i class="fas fa-arrow-down"></i>
                    </button>
                </div>
            </div>

            <!-- Filtered Parts Modal -->
            <div id="filteredPartsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
                <div style="background: white; margin: 50px auto; max-width: 1200px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; display: flex; flex-direction: column;">
                    <div style="padding: 25px; border-bottom: 2px solid var(--beige-dark); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-dark);" id="filteredModalTitle">
                            <i class="fas fa-list"></i> Parts List
                        </h2>
                        <button onclick="closeFilteredPartsModal()" style="background: var(--orange-dark); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#e55a2a';" onmouseout="this.style.background='var(--orange-dark)';">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                    <div style="padding: 25px; overflow-y: auto; flex: 1;">
                        <div id="filteredPartsTable" style="overflow-x: auto;">
                            <!-- Table will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parts List -->
            <div id="partsContainer" style="margin-top: 30px;">
                <div style="text-align: center; padding: 40px; color: var(--text-light);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <p>Loading parts...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="admin-utils.js"></script>
    <script>
        // Check admin authentication
        function checkAdminAuth() {
            if (sessionStorage.getItem('isAdmin') !== 'true') {
                window.location.href = 'admin-login.html';
                return false;
            }
            return true;
        }

        // Logout function
        function logoutAdmin() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('isAdmin');
                sessionStorage.removeItem('adminLoginTime');
                window.location.href = 'admin-login.html';
            }
        }

        // Store all parts globally for filtering
        let allPartsData = [];

        // Load parts on page load
        async function loadParts() {
            if (!checkAdminAuth()) return;

            try {
                // Admin needs stock info, so we'll fetch all fields including stock
                const response = await fetch(`${window.API_BASE_URL}/parts`);
                const result = await response.json();

                if (result.success && result.data) {
                    // For admin, we need to fetch individual parts to get stock info
                    // since the list endpoint excludes stock
                    const partsWithStock = await Promise.all(
                        result.data.map(async (part) => {
                            try {
                                const partResponse = await fetch(`${window.API_BASE_URL}/parts/${part._id}`);
                                const partResult = await partResponse.json();
                                return partResult.success ? partResult.data : part;
                            } catch (e) {
                                return part;
                            }
                        })
                    );
                    // Store parts globally
                    allPartsData = partsWithStock;
                    displayParts(partsWithStock);
                    updateInventorySummary(partsWithStock);
                } else {
                    document.getElementById('partsContainer').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-light);">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 15px;"></i>
                            <p>No parts found. Click "Add New Part" to get started.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading parts:', error);
                document.getElementById('partsContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f44336;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>Error loading parts. Please check your connection and try again.</p>
                    </div>
                `;
            }
        }

        // Update inventory summary
        function updateInventorySummary(parts) {
            let totalParts = parts.length;
            let totalStock = 0;
            let lowStockCount = 0;
            let outOfStockCount = 0;
            const lowStockItems = [];

            parts.forEach(part => {
                const stock = part.stockQuantity !== undefined ? parseInt(part.stockQuantity) : 0;
                const threshold = part.lowStockThreshold !== undefined ? parseInt(part.lowStockThreshold) : 5;
                
                totalStock += stock;
                
                if (stock === 0) {
                    outOfStockCount++;
                } else if (stock <= threshold) {
                    lowStockCount++;
                    lowStockItems.push(part);
                }
            });

            document.getElementById('totalParts').textContent = totalParts;
            document.getElementById('totalStock').textContent = totalStock.toLocaleString();
            document.getElementById('lowStockCount').textContent = lowStockCount;
            document.getElementById('outOfStockCount').textContent = outOfStockCount;

            // Show/hide low stock banner
            const banner = document.getElementById('lowStockBanner');
            if (lowStockCount > 0 || outOfStockCount > 0) {
                banner.style.display = 'block';
                const message = outOfStockCount > 0 
                    ? `${outOfStockCount} item(s) out of stock, ${lowStockCount} item(s) running low`
                    : `${lowStockCount} item(s) running low on stock`;
                document.getElementById('lowStockMessage').textContent = message;
            } else {
                banner.style.display = 'none';
            }
        }

        // Scroll to low stock items
        function scrollToLowStock() {
            const lowStockElements = document.querySelectorAll('.low-stock-item');
            if (lowStockElements.length > 0) {
                lowStockElements[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Display parts
        function displayParts(parts) {
            const container = document.getElementById('partsContainer');
            
            if (parts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>No parts found. Click "Add New Part" to get started.</p>
                    </div>
                `;
                return;
            }

            // Group by category
            const partsByCategory = {};
            parts.forEach(part => {
                const category = part.category || 'uncategorized';
                if (!partsByCategory[category]) {
                    partsByCategory[category] = [];
                }
                partsByCategory[category].push(part);
            });

            let html = '';
            Object.keys(partsByCategory).forEach(category => {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h2 style="font-size: 1.5rem; color: var(--text-dark); margin-bottom: 20px; text-transform: capitalize; border-bottom: 2px solid var(--orange-dark); padding-bottom: 10px;">
                            ${category.replace(/-/g, ' ')}
                        </h2>
                        <div class="parts-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                `;

                partsByCategory[category].forEach(part => {
                    const stock = part.stockQuantity !== undefined ? parseInt(part.stockQuantity) : 0;
                    const threshold = part.lowStockThreshold !== undefined ? parseInt(part.lowStockThreshold) : 5;
                    const isLowStock = stock > 0 && stock <= threshold;
                    const isOutOfStock = stock === 0;
                    const stockClass = isOutOfStock ? 'out-of-stock-item' : (isLowStock ? 'low-stock-item' : '');
                    const stockColor = isOutOfStock ? '#dc3545' : (isLowStock ? '#ff9800' : '#4caf50');
                    const stockBg = isOutOfStock ? '#f8d7da' : (isLowStock ? '#fff3cd' : '#d4edda');
                    
                    html += `
                        <div class="part-card admin-mode ${stockClass}" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; ${isLowStock || isOutOfStock ? 'border-left: 4px solid ' + stockColor + ';' : ''}">
                            <div class="admin-part-actions">
                                <button class="admin-edit-btn" onclick="openEditPartModal('${part._id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="admin-delete-btn" onclick="deletePart('${part._id}', '${part.partName.replace(/'/g, "\\'")}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            ${isLowStock || isOutOfStock ? `
                                <div style="position: absolute; top: 10px; right: 50px; background: ${stockBg}; color: ${stockColor}; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; z-index: 10;">
                                    <i class="fas ${isOutOfStock ? 'fa-times-circle' : 'fa-exclamation-triangle'}"></i> ${isOutOfStock ? 'Out of Stock' : 'Low Stock'}
                                </div>
                            ` : ''}
                            ${part.image ? `
                                <div style="width: 100%; height: 200px; margin-bottom: 15px; border-radius: 8px; overflow: hidden; background: var(--beige-light);">
                                    <img src="${part.image}" alt="${part.partName}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div style="width: 100%; height: 100%; display: none; align-items: center; justify-content: center; background: var(--beige-light);">
                                        <i class="fas fa-image" style="font-size: 2rem; color: var(--text-light);"></i>
                                    </div>
                                </div>
                            ` : `
                                <div style="width: 100%; height: 200px; margin-bottom: 15px; border-radius: 8px; background: var(--beige-light); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-image" style="font-size: 2rem; color: var(--text-light);"></i>
                                </div>
                            `}
                            <h3 style="font-size: 1.2rem; color: var(--text-dark); margin-bottom: 10px; font-weight: 600;">${part.partName}</h3>
                            <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 5px;">
                                <strong>Part Number:</strong> ${part.partNumber || 'N/A'}
                            </div>
                            <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 5px;">
                                <strong>Car Brand:</strong> ${part.carBrand || 'N/A'}
                            </div>
                            <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 5px;">
                                <strong>Part Brand:</strong> ${part.partBrand || 'N/A'}
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--beige-dark); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                ${part.price ? `
                                    <div>
                                        <span style="font-size: 1.3rem; color: var(--orange-dark); font-weight: 700;">â‚¹${parseFloat(part.price).toLocaleString('en-IN')}</span>
                                    </div>
                                ` : ''}
                                <div style="text-align: right;">
                                    <div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 3px;">Stock</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: ${stockColor};">
                                        <i class="fas fa-boxes"></i> ${stock.toLocaleString()}
                                    </div>
                                    ${threshold > 0 ? `
                                        <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 2px;">
                                            Threshold: ${threshold}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Show filtered parts modal
        function showFilteredParts(filterType) {
            if (!allPartsData || allPartsData.length === 0) {
                alert('No parts data available. Please wait for parts to load.');
                return;
            }

            let filteredParts = [];
            let title = '';

            switch(filterType) {
                case 'all':
                    filteredParts = allPartsData;
                    title = 'All Parts';
                    break;
                case 'lowStock':
                    filteredParts = allPartsData.filter(part => {
                        const stock = part.stockQuantity !== undefined ? parseInt(part.stockQuantity) : 0;
                        const threshold = part.lowStockThreshold !== undefined ? parseInt(part.lowStockThreshold) : 5;
                        return stock > 0 && stock <= threshold;
                    });
                    title = 'Low Stock Items';
                    break;
                case 'outOfStock':
                    filteredParts = allPartsData.filter(part => {
                        const stock = part.stockQuantity !== undefined ? parseInt(part.stockQuantity) : 0;
                        return stock === 0;
                    });
                    title = 'Out of Stock Items';
                    break;
                case 'totalStock':
                    // Show all parts sorted by stock quantity
                    filteredParts = [...allPartsData].sort((a, b) => {
                        const stockA = a.stockQuantity !== undefined ? parseInt(a.stockQuantity) : 0;
                        const stockB = b.stockQuantity !== undefined ? parseInt(b.stockQuantity) : 0;
                        return stockB - stockA; // Descending order
                    });
                    title = 'All Parts (Sorted by Stock)';
                    break;
            }

            displayFilteredPartsTable(filteredParts, title);
            document.getElementById('filteredPartsModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Display filtered parts in table
        function displayFilteredPartsTable(parts, title) {
            document.getElementById('filteredModalTitle').innerHTML = `<i class="fas fa-list"></i> ${title} (${parts.length})`;
            
            if (parts.length === 0) {
                document.getElementById('filteredPartsTable').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>No parts found in this category.</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr style="background: var(--beige-light); border-bottom: 2px solid var(--orange-dark);">
                            <th style="padding: 15px; text-align: left; font-weight: 600; color: var(--text-dark);">Car Brand</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600; color: var(--text-dark);">Part Number</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600; color: var(--text-dark);">Part Brand</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: var(--text-dark);">Quantity</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600; color: var(--text-dark);">Category</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: var(--text-dark);">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            parts.forEach((part, index) => {
                const stock = part.stockQuantity !== undefined ? parseInt(part.stockQuantity) : 0;
                const threshold = part.lowStockThreshold !== undefined ? parseInt(part.lowStockThreshold) : 5;
                const isLowStock = stock > 0 && stock <= threshold;
                const isOutOfStock = stock === 0;
                const rowColor = isOutOfStock ? '#f8d7da' : (isLowStock ? '#fff3cd' : 'white');
                const stockColor = isOutOfStock ? '#dc3545' : (isLowStock ? '#f57c00' : '#4caf50');

                tableHTML += `
                    <tr style="background: ${rowColor}; border-bottom: 1px solid var(--beige-dark); transition: all 0.2s;" onmouseover="this.style.background='${isOutOfStock ? '#f5c6cb' : (isLowStock ? '#ffeaa7' : '#f0f0f0')}';" onmouseout="this.style.background='${rowColor}';">
                        <td style="padding: 12px 15px; color: var(--text-dark);">${part.carBrand || 'N/A'}</td>
                        <td style="padding: 12px 15px; color: var(--text-dark); font-weight: 500;">${part.partNumber || 'N/A'}</td>
                        <td style="padding: 12px 15px; color: var(--text-dark);">${part.partBrand || 'N/A'}</td>
                        <td style="padding: 12px 15px; text-align: center;">
                            <span style="color: ${stockColor}; font-weight: 700; font-size: 1.1rem;">${stock.toLocaleString()}</span>
                            ${isLowStock || isOutOfStock ? `
                                <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 2px;">
                                    ${isOutOfStock ? 'Out of Stock' : `Threshold: ${threshold}`}
                                </div>
                            ` : ''}
                        </td>
                        <td style="padding: 12px 15px; color: var(--text-light); text-transform: capitalize;">${(part.category || 'N/A').replace(/-/g, ' ')}</td>
                        <td style="padding: 12px 15px; text-align: center;">
                            <button onclick="openEditPartModal('${part._id}'); closeFilteredPartsModal();" style="background: var(--orange-medium); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85rem; margin-right: 5px; transition: all 0.2s;" onmouseover="this.style.background='var(--orange-dark)';" onmouseout="this.style.background='var(--orange-medium)';" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('filteredPartsTable').innerHTML = tableHTML;
        }

        // Close filtered parts modal
        function closeFilteredPartsModal() {
            document.getElementById('filteredPartsModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('filteredPartsModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeFilteredPartsModal();
                    }
                });
            }

            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal && modal.style.display === 'block') {
                    closeFilteredPartsModal();
                }
            });
        });

        // Make functions globally accessible
        window.loadParts = loadParts;
        window.scrollToLowStock = scrollToLowStock;
        window.showFilteredParts = showFilteredParts;
        window.closeFilteredPartsModal = closeFilteredPartsModal;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadParts();
        });
    </script>
</body>
</html>

